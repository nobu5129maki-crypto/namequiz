<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ã‚¤ã‚ºãƒ»ãƒã‚¹ã‚¿ãƒ¼Pro - æœ‰åäººåå‰å½“ã¦ã‚¯ã‚¤ã‚º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500;700&display=swap');
        body {
            font-family: 'Kiwi Maru', serif;
            background: #f8fafc;
        }
        .quiz-card {
            background: white;
            border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }
        .hint-item {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(20px);
            opacity: 0;
        }
        .hint-item.show {
            transform: translateY(0);
            opacity: 1;
        }
        .premium-grad {
            background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
        }
        .loading-spinner {
            border: 4px solid rgba(249, 115, 22, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #f97316;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .app-icon {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app" class="w-full max-w-md quiz-card overflow-hidden">
        <!-- Header -->
        <div class="premium-grad p-8 text-white text-center shadow-lg">
            <div class="flex flex-col items-center justify-center space-y-4">
                <img src="https://via.placeholder.com/80?text=Quiz" alt="App Icon" class="app-icon" onerror="this.src='https://via.placeholder.com/80?text=Quiz'">
                <h1 class="text-3xl font-black tracking-tighter">ã‚¯ã‚¤ã‚ºãƒ»ãƒã‚¹ã‚¿ãƒ¼ Pro</h1>
            </div>
            <p class="text-orange-100 text-sm mt-2 font-medium tracking-widest uppercase">Premium Edition</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="p-10 space-y-8 text-center">
            <div class="space-y-6">
                <div class="bg-orange-50 p-6 rounded-[2rem] border border-orange-100">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">ã‚ãªãŸã®æœ€é«˜ã‚¹ã‚³ã‚¢</p>
                    <p class="text-4xl font-black text-orange-600 font-sans"><span id="high-score-display">0</span> <span class="text-base font-normal">ç‚¹</span></p>
                </div>
                <div class="space-y-2">
                    <p class="text-gray-700 font-bold text-lg text-orange-600">10å•é€£ç¶šãƒãƒ£ãƒ¬ãƒ³ã‚¸</p>
                    <p class="text-gray-400 text-xs leading-relaxed">
                        å°‘ãªã„ãƒ’ãƒ³ãƒˆã§æ­£è§£ã—ã¦ã€æœ€é«˜ãƒ©ãƒ³ã‚¯ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼<br>
                        å¾—æ„ãªå¹´ä»£ã‚’é¸æŠã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="startGame(20)" class="bg-white hover:bg-orange-500 hover:text-white text-orange-600 py-4 rounded-2xl font-bold border-2 border-orange-500 transition-all shadow-sm active:scale-95">20ä»£</button>
                <button onclick="startGame(30)" class="bg-white hover:bg-orange-500 hover:text-white text-orange-600 py-4 rounded-2xl font-bold border-2 border-orange-500 transition-all shadow-sm active:scale-95">30ä»£</button>
                <button onclick="startGame(40)" class="bg-white hover:bg-orange-500 hover:text-white text-orange-600 py-4 rounded-2xl font-bold border-2 border-orange-500 transition-all shadow-sm active:scale-95">40ä»£</button>
                <button onclick="startGame(50)" class="bg-white hover:bg-orange-500 hover:text-white text-orange-600 py-4 rounded-2xl font-bold border-2 border-orange-500 transition-all shadow-sm active:scale-95">50ä»£ä»¥ä¸Š</button>
            </div>
            <button onclick="showHistory()" class="w-full mt-4 text-slate-400 text-sm font-bold flex items-center justify-center gap-2 py-2 hover:text-orange-500 transition">
                <span>ğŸ“–</span> éå»ã«æ­£è§£ã—ãŸæœ‰åäººãƒªã‚¹ãƒˆ
            </button>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="hidden p-8 space-y-6 max-h-[600px] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-xl font-black text-slate-800 tracking-tighter">æ­£è§£ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
                <button onclick="backToTitle()" class="text-slate-400 hover:text-red-500 text-2xl">Ã—</button>
            </div>
            <div id="history-list" class="space-y-3"></div>
            <button onclick="backToTitle()" class="w-full bg-slate-100 py-4 rounded-2xl font-bold text-slate-500 active:scale-95">æˆ»ã‚‹</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden p-8 space-y-8">
            <div class="flex justify-between items-end border-b border-gray-100 pb-4">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">åˆè¨ˆã‚¹ã‚³ã‚¢</p>
                    <p id="total-score" class="text-3xl font-black text-orange-600 font-sans leading-none">0</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">é€²æ—</p>
                    <p class="text-lg font-bold text-gray-600">ç¬¬ <span id="current-idx-display">1</span> / 10 å•</p>
                </div>
            </div>

            <div id="hints-container" class="space-y-4 min-h-[320px]">
                <div id="hint-1" class="hint-item bg-blue-50 border-l-4 border-blue-500 p-5 rounded-r-2xl hidden">
                    <span class="inline-block px-2 py-1 bg-blue-500 text-white text-[10px] font-bold rounded mb-2">ç¬¬1ãƒ’ãƒ³ãƒˆ (100ç‚¹)</span>
                    <p id="hint-1-text" class="text-blue-900 font-bold leading-relaxed"></p>
                </div>
                <div id="hint-2" class="hint-item bg-purple-50 border-l-4 border-purple-500 p-5 rounded-r-2xl hidden">
                    <span class="inline-block px-2 py-1 bg-purple-500 text-white text-[10px] font-bold rounded mb-2">ç¬¬2ãƒ’ãƒ³ãƒˆ (50ç‚¹)</span>
                    <p id="hint-2-text" class="text-purple-900 font-bold leading-relaxed"></p>
                </div>
                <div id="hint-3" class="hint-item bg-yellow-50 border-l-4 border-yellow-500 p-5 rounded-r-2xl hidden">
                    <span class="inline-block px-2 py-1 bg-yellow-500 text-yellow-900 text-[10px] font-bold rounded mb-2">ç¬¬3ãƒ’ãƒ³ãƒˆ (30ç‚¹)</span>
                    <p id="hint-3-text" class="text-yellow-900 font-bold leading-relaxed"></p>
                </div>
            </div>

            <div class="space-y-4 pt-6">
                <input type="text" id="answer-input" placeholder="ã“ã“ã«ãŠåå‰ã‚’å…¥åŠ›" autocomplete="off"
                       class="w-full px-6 py-5 bg-gray-50 border-2 border-transparent rounded-2xl focus:border-orange-400 focus:bg-white outline-none text-center text-xl font-black transition-all shadow-inner">
                <div class="flex gap-4">
                    <button id="next-hint-btn" onclick="revealNextHint()" class="flex-1 bg-white border-2 border-slate-200 text-slate-600 hover:border-orange-500 hover:text-orange-500 font-bold py-5 rounded-2xl transition-all active:scale-95">æ¬¡ã®ãƒ’ãƒ³ãƒˆ</button>
                    <button id="submit-btn" onclick="checkAnswer()" class="flex-[1.5] premium-grad text-white font-black py-5 rounded-2xl shadow-xl transition-all active:scale-95">å›ç­”ã‚’ç¢ºå®šã™ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- Alert Modal -->
        <div id="message-box" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[100] p-6">
            <div class="bg-white rounded-3xl p-8 w-full max-w-sm text-center space-y-4 shadow-2xl">
                <p id="message-text" class="text-slate-700 font-bold"></p>
                <button onclick="closeMessageBox()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <!-- Result Modal -->
        <div id="result-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-50 p-6">
            <div class="bg-white rounded-[3rem] p-10 w-full max-w-xs text-center space-y-6 shadow-2xl">
                <div id="result-emoji" class="text-8xl"></div>
                <div>
                    <h2 id="result-title" class="text-4xl font-black"></h2>
                    <p id="earned-points" class="text-orange-600 font-black mt-2 text-xl"></p>
                </div>
                <div class="p-5 bg-slate-50 rounded-2xl">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">æ­£è§£ã¯ã“ã¡ã‚‰</p>
                    <span id="correct-name" class="text-2xl font-black text-slate-800"></span>
                </div>
                <button id="modal-next-btn" onclick="closeModal()" class="w-full premium-grad text-white py-5 rounded-2xl font-black shadow-lg transition active:scale-95">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>

        <!-- Final Score Screen -->
        <div id="final-screen" class="hidden p-10 text-center space-y-10">
            <div class="space-y-2">
                <div class="text-7xl mb-4">ğŸ‘‘</div>
                <h2 class="text-4xl font-black text-slate-800 tracking-tighter">çµ‚äº†ã§ã™ï¼</h2>
                <p class="text-slate-500">10å•ã®æŒ‘æˆ¦ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚</p>
            </div>
            <div class="relative py-10 bg-slate-50 rounded-[3rem]">
                <p class="text-7xl font-black text-orange-600 font-sans" id="final-score-display">0</p>
                <p class="text-xs font-bold text-orange-400 mt-2 tracking-widest uppercase">Total Points</p>
                <div id="new-record-badge" class="hidden absolute -top-4 -right-4 bg-red-500 text-white text-[10px] font-black px-4 py-2 rounded-full shadow-lg rotate-12 animate-pulse">æœ€é«˜è¨˜éŒ²æ›´æ–°ï¼</div>
            </div>
            <button onclick="backToTitle()" class="w-full bg-slate-800 text-white py-6 rounded-2xl font-black shadow-2xl transition active:scale-95 uppercase tracking-widest">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden fixed inset-0 bg-white/95 z-50 flex flex-col items-center justify-center">
        <div class="loading-spinner"></div>
        <p class="mt-6 font-black text-orange-600 uppercase tracking-widest text-xs">å•é¡Œã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...</p>
    </div>

    <script>
        /**
         * APIã‚­ãƒ¼ã®è¨­å®šã«ã¤ã„ã¦:
         * Vercelã®ç’°å¢ƒå¤‰æ•° GEMINI_API_KEY ã‚’å‚ç…§ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚
         * ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚„ã€æ³¨å…¥ã•ã‚Œãªã„ç’°å¢ƒã§ã¯ç©ºæ–‡å­—ã«ãªã‚Šã¾ã™ã€‚
         */
        const apiKey = typeof __GEMINI_API_KEY__ !== 'undefined' ? __GEMINI_API_KEY__ : "";

        let targetName = "";
        let currentTotalScore = 0;
        let currentQuestionIdx = 1;
        let currentHintLevel = 0;
        let hints = [];
        let pastCelebrities = [];
        const MAX_QUESTIONS = 10;
        let currentAge = 20;

        function showMessage(text) {
            document.getElementById('message-text').innerText = text;
            document.getElementById('message-box').classList.remove('hidden');
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }

        let highScore = localStorage.getItem('quiz_high_score_pro') || 0;
        document.getElementById('high-score-display').innerText = highScore;

        async function fetchAI(url, body) {
            // apiKeyãŒç©ºã®å ´åˆã®ãƒã‚§ãƒƒã‚¯
            if (!apiKey || apiKey === "") {
                throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Vercelã®ç’°å¢ƒå¤‰æ•° GEMINI_API_KEY ã«å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            }
            
            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const res = await fetch(`${url}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    
                    if (res.ok) return await res.json();
                    
                    if (res.status === 401 || res.status === 403) {
                        throw new Error("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚Vercelã®è¨­å®šç”»é¢ã§æ­£ã—ã„ã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    }
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                }
                await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
            }
        }

        async function startGame(age) {
            currentAge = age;
            currentTotalScore = 0;
            currentQuestionIdx = 1;
            pastCelebrities = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('total-score').innerText = "0";
            nextQuestion();
        }

        async function nextQuestion() {
            if (currentQuestionIdx > MAX_QUESTIONS) {
                showFinalResult();
                return;
            }

            const loader = document.getElementById('loading-screen');
            loader.classList.remove('hidden');
            
            currentHintLevel = 0;
            for(let i=1; i<=3; i++) {
                const h = document.getElementById(`hint-${i}`);
                h.classList.add('hidden');
                h.classList.remove('show');
            }
            document.getElementById('next-hint-btn').disabled = false;
            document.getElementById('answer-input').value = "";
            document.getElementById('current-idx-display').innerText = currentQuestionIdx;

            try {
                const excluded = pastCelebrities.length > 0 ? `éå»ã«å‡ºé¡Œã—ãŸäºº: ${pastCelebrities.join(', ')}ã€‚ã“ã‚Œã‚‰ã¨ã¯åˆ¥ã®äººã‚’é¸ã‚“ã§ãã ã•ã„ã€‚` : "";
                const response = await fetchAI(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`,
                    {
                        contents: [{ parts: [{ text: `ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¯ã‚¤ã‚ºåˆ¶ä½œä½œå®¶ã§ã™ã€‚${currentAge}ä»£ã®æ—¥æœ¬äººã«éå¸¸ã«æœ‰åãªäººç‰©ï¼ˆå­˜å‘½ãƒ»æ•…äººå•ã‚ãšï¼‰ã‚’1äººé¸ã³ã€3æ®µéšã®ã‚¯ã‚¤ã‚ºã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                        ${excluded}
                        ã€ãƒ’ãƒ³ãƒˆã®ä½œã‚Šæ–¹ã€‘
                        1. ãƒ’ãƒ³ãƒˆ1(100ç‚¹): è·æ¥­ã‚„ä¸»è¦ãªåŠŸç¸¾ï¼ˆåå‰ã‚’æ¨æ¸¬ã§ãã‚‹ã‚®ãƒªã‚®ãƒªã®æŠ½è±¡åº¦ã§ï¼‰
                        2. ãƒ’ãƒ³ãƒˆ2(50ç‚¹): å…·ä½“çš„ãªä»£è¡¨ä½œå“ã‚„æœ‰åãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
                        3. ãƒ’ãƒ³ãƒˆ3(30ç‚¹): åå­—ã®æœ€åˆã®1æ–‡å­—ï¼ˆä¾‹ï¼šåå­—ãŒã€Œä½è—¤ã€ãªã‚‰ã€Œã•ã€ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
                        
                        JSONå½¢å¼ã®ã¿ã§å‡ºåŠ›ï¼š{"name": "ãƒ•ãƒ«ãƒãƒ¼ãƒ ", "hint1": "...", "hint2": "...", "hint3": "..."}` }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    }
                );
                
                const data = JSON.parse(response.candidates[0].content.parts[0].text);
                targetName = data.name;
                hints = [data.hint1, data.hint2, data.hint3];
                pastCelebrities.push(targetName);

                loader.classList.add('hidden');
                revealNextHint();
            } catch (e) {
                loader.classList.add('hidden');
                showMessage(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
                backToTitle();
            }
        }

        function revealNextHint() {
            if (currentHintLevel >= 3) return;
            currentHintLevel++;
            const hintElem = document.getElementById(`hint-${currentHintLevel}`);
            document.getElementById(`hint-${currentHintLevel}-text`).innerText = hints[currentHintLevel - 1];
            hintElem.classList.remove('hidden');
            setTimeout(() => hintElem.classList.add('show'), 50);
            if (currentHintLevel === 3) document.getElementById('next-hint-btn').disabled = true;
        }

        function checkAnswer() {
            const input = document.getElementById('answer-input').value.trim();
            if (!input) return;

            const normalize = (s) => s.replace(/\s+/g, '').replace(/[ã-ã‚“]/g, m => String.fromCharCode(m.charCodeAt(0) + 0x60));
            const isCorrect = normalize(input) === normalize(targetName);
            
            const modal = document.getElementById('result-modal');
            let points = 0;
            if (isCorrect) {
                points = currentHintLevel === 1 ? 100 : (currentHintLevel === 2 ? 50 : 30);
                currentTotalScore += points;
                document.getElementById('total-score').innerText = currentTotalScore;
                document.getElementById('result-emoji').innerText = "ğŸ‰";
                document.getElementById('result-title').innerText = "æ­£è§£ã§ã™ï¼";
                document.getElementById('earned-points').innerText = `+${points} ãƒã‚¤ãƒ³ãƒˆç²å¾—`;
                saveToHistory(targetName); 
            } else {
                document.getElementById('result-emoji').innerText = "âŒ";
                document.getElementById('result-title').innerText = "æ®‹å¿µ...";
                document.getElementById('earned-points').innerText = "0 ãƒã‚¤ãƒ³ãƒˆ";
            }
            document.getElementById('correct-name').innerText = targetName;
            modal.classList.remove('hidden');
            document.getElementById('modal-next-btn').innerText = currentQuestionIdx === MAX_QUESTIONS ? "æœ€çµ‚çµæœã‚’è¦‹ã‚‹" : "æ¬¡ã®å•é¡Œã¸";
        }

        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
            currentQuestionIdx++;
            nextQuestion();
        }

        function saveToHistory(name) {
            let history = JSON.parse(localStorage.getItem('quiz_history_pro') || '[]');
            if (!history.includes(name)) {
                history.push(name);
                localStorage.setItem('quiz_history_pro', JSON.stringify(history));
            }
        }

        function showHistory() {
            const history = JSON.parse(localStorage.getItem('quiz_history_pro') || '[]');
            const listElem = document.getElementById('history-list');
            listElem.innerHTML = '';
            
            if (history.length === 0) {
                listElem.innerHTML = '<p class="text-slate-400 text-center py-10">ã¾ã æ­£è§£ã—ãŸæœ‰åäººãŒã„ã¾ã›ã‚“ã€‚</p>';
            } else {
                history.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'bg-slate-50 p-4 rounded-xl font-bold text-slate-700 border border-slate-100 flex justify-between items-center';
                    div.innerHTML = `<span>${name}</span><span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-md">Collected</span>`;
                    listElem.appendChild(div);
                });
            }
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('history-screen').classList.remove('hidden');
        }

        function backToTitle() {
            document.getElementById('history-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('high-score-display').innerText = localStorage.getItem('quiz_high_score_pro') || 0;
        }

        function showFinalResult() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
            document.getElementById('final-score-display').innerText = currentTotalScore;

            if (currentTotalScore > highScore) {
                localStorage.setItem('quiz_high_score_pro', currentTotalScore);
                document.getElementById('new-record-badge').classList.remove('hidden');
                highScore = currentTotalScore;
            } else {
                document.getElementById('new-record-badge').classList.add('hidden');
            }
        }
    </script>
</body>
</html>