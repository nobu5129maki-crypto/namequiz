<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÇØ„Ç§„Ç∫„Éª„Éû„Çπ„Çø„ÉºPro - ÊúâÂêç‰∫∫ÂêçÂâçÂΩì„Å¶„ÇØ„Ç§„Ç∫</title>
    <!-- iOS„Éõ„Éº„É†ÁîªÈù¢Áî®„Ç¢„Ç§„Ç≥„É≥Ë®≠ÂÆö -->
    <link rel="apple-touch-icon" href="icon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500;700&display=swap');
        body {
            font-family: 'Kiwi Maru', serif;
            background: #f8fafc;
        }
        .quiz-card {
            background: white;
            border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }
        .hint-item {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(20px);
            opacity: 0;
        }
        .hint-item.show {
            transform: translateY(0);
            opacity: 1;
        }
        .premium-grad {
            background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
        }
        .loading-spinner {
            border: 4px solid rgba(249, 115, 22, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #f97316;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* „Ç¢„Ç§„Ç≥„É≥Ë°®Á§∫Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .app-icon {
            width: 64px;
            height: 64px;
            object-fit: contain;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app" class="w-full max-w-md quiz-card overflow-hidden">
        <!-- Header -->
        <div class="premium-grad p-8 text-white text-center shadow-lg">
            <div class="flex flex-col items-center justify-center mb-2">
                <!-- „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åüicon.svg„ÇíË°®Á§∫ -->
                <img src="icon.svg" alt="App Icon" class="app-icon mb-2">
                <h1 class="text-3xl font-black tracking-tighter">„ÇØ„Ç§„Ç∫„Éª„Éû„Çπ„Çø„Éº Pro</h1>
            </div>
            <p class="text-orange-100 text-sm font-medium tracking-widest uppercase">Premium Challenge Mode</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="p-10 space-y-8 text-center">
            <div class="bg-orange-50 p-6 rounded-[2rem] border border-orange-100">
                <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">„ÅÇ„Å™„Åü„ÅÆÊúÄÈ´ò„Çπ„Ç≥„Ç¢</p>
                <p class="text-4xl font-black text-orange-600 font-sans"><span id="high-score-display">0</span> <span class="text-base font-normal">ÁÇπ</span></p>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 font-bold">Âπ¥‰ª£„ÇíÈÅ∏„Çì„Åß10ÂïèÈÄ£Á∂ö„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="startGame(20)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">20‰ª£</button>
                    <button onclick="startGame(30)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">30‰ª£</button>
                    <button onclick="startGame(40)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">40‰ª£</button>
                    <button onclick="startGame(50)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">50‰ª£‰ª•‰∏ä</button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden p-8 space-y-8">
            <div class="flex justify-between items-end border-b border-gray-100 pb-4">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ÂêàË®à„Çπ„Ç≥„Ç¢</p>
                    <p id="total-score" class="text-3xl font-black text-orange-600 font-sans leading-none">0</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ÈÄ≤Êçó</p>
                    <p class="text-lg font-bold text-gray-600">Á¨¨ <span id="current-idx-display">1</span> / 10 Âïè</p>
                </div>
            </div>

            <div id="hints-container" class="space-y-4 min-h-[320px]">
                <div id="hint-1" class="hint-item bg-blue-50 border-l-4 border-blue-500 p-5 rounded-r-2xl hidden">
                    <span class="inline-block px-2 py-1 bg-blue-500 text-white text-[10px] font-bold rounded mb-2">Á¨¨1„Éí„É≥„Éà (100ÁÇπ)</span>
                    <p id="hint-1-text" class="text-blue-900 font-bold leading-relaxed"></p>
                </div>
                <div id="hint-2" class="hint-item bg-purple-50 border-l-4 border-purple-500 p-5 rounded-r-2xl hidden">
                    <span class="inline-block px-2 py-1 bg-purple-500 text-white text-[10px] font-bold rounded mb-2">Á¨¨2„Éí„É≥„Éà (50ÁÇπ)</span>
                    <p id="hint-2-text" class="text-purple-900 font-bold leading-relaxed"></p>
                </div>
                <div id="hint-3" class="hint-item bg-yellow-50 border-l-4 border-yellow-500 p-5 rounded-r-2xl hidden">
                    <span class="inline-block px-2 py-1 bg-yellow-500 text-yellow-900 text-[10px] font-bold rounded mb-2">Á¨¨3„Éí„É≥„Éà (30ÁÇπ)</span>
                    <p id="hint-3-text" class="text-yellow-900 font-bold leading-relaxed"></p>
                </div>
            </div>

            <div class="space-y-4 pt-6">
                <input type="text" id="answer-input" placeholder="„Åì„Åì„Å´„ÅäÂêçÂâç„ÇíÂÖ•Âäõ" autocomplete="off"
                       class="w-full px-6 py-5 bg-gray-50 border-2 border-transparent rounded-2xl focus:border-orange-400 focus:bg-white outline-none text-center text-xl font-black transition-all shadow-inner">
                <div class="flex gap-4">
                    <button id="next-hint-btn" onclick="revealNextHint()" class="flex-1 bg-white border-2 border-slate-200 text-slate-600 font-bold py-5 rounded-2xl transition-all active:scale-95">„Éí„É≥„Éà</button>
                    <button id="submit-btn" onclick="checkAnswer()" class="flex-[1.5] premium-grad text-white font-black py-5 rounded-2xl shadow-xl transition-all active:scale-95">ÂõûÁ≠îÁ¢∫ÂÆö</button>
                </div>
            </div>
        </div>

        <!-- Result Modal -->
        <div id="result-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-50 p-6">
            <div class="bg-white rounded-[3rem] p-10 w-full max-w-xs text-center space-y-6 shadow-2xl">
                <div id="result-emoji" class="text-8xl"></div>
                <div>
                    <h2 id="result-title" class="text-3xl font-black"></h2>
                </div>
                <div class="p-5 bg-slate-50 rounded-2xl">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">Ê≠£Ëß£</p>
                    <span id="correct-name" class="text-2xl font-black text-slate-800"></span>
                </div>
                <button id="modal-next-btn" onclick="closeModal()" class="w-full premium-grad text-white py-5 rounded-2xl font-black shadow-lg transition active:scale-95">Ê¨°„Å∏ÈÄ≤„ÇÄ</button>
            </div>
        </div>

        <!-- Final Score Screen -->
        <div id="final-screen" class="hidden p-10 text-center space-y-10">
            <div class="space-y-2">
                <div class="text-7xl mb-4">üëë</div>
                <h2 class="text-4xl font-black text-slate-800 tracking-tighter">ÁµÇ‰∫ÜÔºÅ</h2>
                <p class="text-slate-500">10Âïè„ÅÆÊåëÊà¶„ÅåÁµÇ„Çè„Çä„Åæ„Åó„Åü„ÄÇ</p>
            </div>
            <div class="relative py-10 bg-slate-50 rounded-[3rem]">
                <p class="text-7xl font-black text-orange-600 font-sans" id="final-score-display">0</p>
                <p class="text-xs font-bold text-orange-400 mt-2 tracking-widest uppercase">Total Points</p>
                <div id="new-record-badge" class="hidden absolute -top-4 -right-4 bg-red-500 text-white text-[10px] font-black px-4 py-2 rounded-full shadow-lg rotate-12 animate-pulse">NEW RECORD!</div>
            </div>
            <button onclick="location.reload()" class="w-full bg-slate-800 text-white py-6 rounded-2xl font-black shadow-2xl transition active:scale-95">„Çø„Ç§„Éà„É´„Å´Êàª„Çã</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden fixed inset-0 bg-white/95 z-50 flex flex-col items-center justify-center">
        <div class="loading-spinner"></div>
        <p class="mt-6 font-black text-orange-600 uppercase tracking-widest text-xs">AI„ÅåÂïèÈ°å„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...</p>
    </div>

    <script>
        let targetName = "";
        let currentTotalScore = 0;
        let currentQuestionIdx = 1;
        let currentHintLevel = 0;
        let hints = [];
        let usedNames = []; // ÈÅéÂéª„Å´Âá∫„ÅüÂêçÂâç„ÇíË®òÈå≤
        const MAX_QUESTIONS = 10;
        let currentAge = 20;

        async function fetchAI(body) {
            try {
                const res = await fetch('/api/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "ÈÄö‰ø°„Ç®„É©„Éº");
                return data;
            } catch (e) {
                throw e;
            }
        }

        async function startGame(age) {
            currentAge = age;
            currentTotalScore = 0;
            currentQuestionIdx = 1;
            usedNames = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('total-score').innerText = "0";
            nextQuestion();
        }

        async function nextQuestion() {
            if (currentQuestionIdx > MAX_QUESTIONS) {
                showFinalResult();
                return;
            }

            document.getElementById('loading-screen').classList.remove('hidden');
            currentHintLevel = 0;
            document.getElementById('answer-input').value = "";
            document.getElementById('current-idx-display').innerText = currentQuestionIdx;
            
            for(let i=1; i<=3; i++) {
                const h = document.getElementById(`hint-${i}`);
                h.classList.add('hidden');
                h.classList.remove('show');
                document.getElementById(`hint-${i}-text`).innerText = "";
            }

            try {
                const excluded = usedNames.length > 0 ? `ÈÅéÂéª„Å´Âá∫„ÅüÂêçÂâç(${usedNames.join(',')})‰ª•Â§ñ„ÅßÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ` : "";
                const response = await fetchAI({
                    contents: [{ parts: [{ text: `Êó•Êú¨„ÅÆÊúâÂêç‰∫∫„ÇØ„Ç§„Ç∫Ôºà${currentAge}‰ª£Âêë„ÅëÔºâ„Çí1„Å§‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ${excluded}
                    ÂøÖ„Åö‰ª•‰∏ã„ÅÆJSON„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆ„Åø„ÇíÊ≠£Á¢∫„Å´Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

                    {
                      "name": "„Éï„É´„Éç„Éº„É†",
                      "hint1": "„Åù„ÅÆ‰∫∫„ÅÆ„É°„Ç§„É≥„ÅÆËÅ∑Ê•≠„ÇÑÂÆüÁ∏æ",
                      "hint2": "ÂÖ∑‰ΩìÁöÑ„Å™Âá∫Êºî‰Ωú„ÇÑÊúâÂêç„Å™„Ç®„Éî„ÇΩ„Éº„Éâ",
                      "hint3": "ËãóÂ≠ó„ÅÆÊúÄÂàù„ÅÆ1ÊñáÂ≠óÔºà‰æãÔºö„Äé„ÅÇ„Äè„Åã„ÇâÂßã„Åæ„ÇãÔºâ"
                    }` }] }],
                    generationConfig: { 
                        responseMimeType: "application/json"
                    }
                });
                
                if (response.candidates && response.candidates[0]) {
                    const contentText = response.candidates[0].content.parts[0].text;
                    const data = JSON.parse(contentText);
                    
                    targetName = data.name || data.ÂêçÂâç || "‰∏çÊòé";
                    usedNames.push(targetName);
                    
                    const h1 = data.hint1 || data.„Éí„É≥„Éà1 || "ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
                    const h2 = data.hint2 || data.„Éí„É≥„Éà2 || "ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
                    const h3 = data.hint3 || data.„Éí„É≥„Éà3 || (targetName.charAt(0) + "„Åã„ÇâÂßã„Åæ„ÇãÂêçÂâç„Åß„Åô");

                    hints = [h1, h2, h3];
                    
                    document.getElementById('loading-screen').classList.add('hidden');
                    revealNextHint();
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                setTimeout(() => nextQuestion(), 1000);
            }
        }

        function revealNextHint() {
            if (currentHintLevel >= 3) return;
            currentHintLevel++;
            const h = document.getElementById(`hint-${currentHintLevel}`);
            const textElement = document.getElementById(`hint-${currentHintLevel}-text`);
            
            if (textElement) {
                const text = hints[currentHintLevel-1];
                textElement.innerText = text;
                h.classList.remove('hidden');
                setTimeout(() => h.classList.add('show'), 50);
            }
            
            const nextBtn = document.getElementById('next-hint-btn');
            if (currentHintLevel === 3) {
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50');
            } else {
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50');
            }
        }

        function checkAnswer() {
            const input = document.getElementById('answer-input').value.trim();
            if (!input) return;

            const normalize = (s) => s.replace(/\s+/g, '').toLowerCase();
            const isCorrect = normalize(input) === normalize(targetName);
            
            if (isCorrect) {
                let points = currentHintLevel === 1 ? 100 : (currentHintLevel === 2 ? 50 : 30);
                currentTotalScore += points;
                document.getElementById('total-score').innerText = currentTotalScore;
                document.getElementById('result-emoji').innerText = "üéâ";
                document.getElementById('result-title').innerText = "Ê≠£Ëß£ÔºÅ";
            } else {
                document.getElementById('result-emoji').innerText = "‚ùå";
                document.getElementById('result-title').innerText = "ÊÆãÂøµ...";
            }
            document.getElementById('correct-name').innerText = targetName;
            document.getElementById('result-modal').classList.remove('hidden');
            document.getElementById('modal-next-btn').innerText = currentQuestionIdx === MAX_QUESTIONS ? "ÊúÄÁµÇÁµêÊûú„ÇíË¶ã„Çã" : "Ê¨°„ÅÆÂïèÈ°å„Å∏";
        }

        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
            // Ê≠£Ëß£„Åß„ÇÇ‰∏çÊ≠£Ëß£„Åß„ÇÇÊ¨°„ÅÆÂïèÈ°åÁï™Âè∑„Å´ÈÄ≤„ÇÄ
            currentQuestionIdx++;
            nextQuestion();
        }

        function showFinalResult() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
            document.getElementById('final-score-display').innerText = currentTotalScore;

            const highScore = parseInt(localStorage.getItem('quiz_high_score_pro') || "0");
            if (currentTotalScore > highScore) {
                localStorage.setItem('quiz_high_score_pro', currentTotalScore);
                document.getElementById('new-record-badge').classList.remove('hidden');
            }
        }

        document.getElementById('high-score-display').innerText = localStorage.getItem('quiz_high_score_pro') || 0;
    </script>
</body>
</html>