<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÇØ„Ç§„Ç∫„Éª„Éû„Çπ„Çø„ÉºPro - ÊúâÂêç‰∫∫ÂêçÂâçÂΩì„Å¶„ÇØ„Ç§„Ç∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500;700&display=swap');
        body {
            font-family: 'Kiwi Maru', serif;
            background: #f8fafc;
        }
        .quiz-card {
            background: white;
            border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }
        .hint-item {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(20px);
            opacity: 0;
        }
        .hint-item.show {
            transform: translateY(0);
            opacity: 1;
        }
        .premium-grad {
            background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
        }
        .loading-spinner {
            border: 4px solid rgba(249, 115, 22, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border-left-color: #f97316;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app" class="w-full max-w-md quiz-card overflow-hidden">
        <!-- Header -->
        <div class="premium-grad p-8 text-white text-center shadow-lg">
            <h1 class="text-3xl font-black tracking-tighter">„ÇØ„Ç§„Ç∫„Éª„Éû„Çπ„Çø„Éº Pro</h1>
            <p class="text-orange-100 text-sm mt-2 font-medium tracking-widest uppercase">Server-Side Protected</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="p-10 space-y-8 text-center">
            <div class="bg-orange-50 p-6 rounded-[2rem] border border-orange-100">
                <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">„ÅÇ„Å™„Åü„ÅÆÊúÄÈ´ò„Çπ„Ç≥„Ç¢</p>
                <p class="text-4xl font-black text-orange-600 font-sans"><span id="high-score-display">0</span> <span class="text-base font-normal">ÁÇπ</span></p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="startGame(20)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">20‰ª£</button>
                <button onclick="startGame(30)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">30‰ª£</button>
                <button onclick="startGame(40)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">40‰ª£</button>
                <button onclick="startGame(50)" class="bg-white border-2 border-orange-500 text-orange-600 py-4 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition shadow-sm active:scale-95">50‰ª£‰ª•‰∏ä</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden p-8 space-y-8">
            <div class="flex justify-between border-b border-gray-100 pb-4">
                <p id="total-score" class="text-3xl font-black text-orange-600">0</p>
                <p class="text-lg font-bold text-gray-600">Á¨¨ <span id="current-idx-display">1</span> / 10 Âïè</p>
            </div>

            <div id="hints-container" class="space-y-4 min-h-[320px]">
                <div id="hint-1" class="hint-item bg-blue-50 border-l-4 border-blue-500 p-5 rounded-r-2xl hidden">
                    <p id="hint-1-text" class="text-blue-900 font-bold"></p>
                </div>
                <div id="hint-2" class="hint-item bg-purple-50 border-l-4 border-purple-500 p-5 rounded-r-2xl hidden">
                    <p id="hint-2-text" class="text-purple-900 font-bold"></p>
                </div>
                <div id="hint-3" class="hint-item bg-yellow-50 border-l-4 border-yellow-500 p-5 rounded-r-2xl hidden">
                    <p id="hint-3-text" class="text-yellow-900 font-bold"></p>
                </div>
            </div>

            <div class="space-y-4 pt-6">
                <input type="text" id="answer-input" placeholder="„Åì„Åì„Å´„ÅäÂêçÂâç„ÇíÂÖ•Âäõ" class="w-full px-6 py-5 bg-gray-50 border-2 border-transparent rounded-2xl focus:border-orange-400 focus:bg-white outline-none text-center text-xl font-black transition shadow-inner">
                <div class="flex gap-4">
                    <button id="next-hint-btn" onclick="revealNextHint()" class="flex-1 bg-white border-2 border-slate-200 text-slate-600 font-bold py-5 rounded-2xl transition active:scale-95">„Éí„É≥„Éà</button>
                    <button id="submit-btn" onclick="checkAnswer()" class="flex-[1.5] premium-grad text-white font-black py-5 rounded-2xl shadow-xl transition active:scale-95">ÂõûÁ≠îÁ¢∫ÂÆö</button>
                </div>
            </div>
        </div>

        <!-- Result Modal -->
        <div id="result-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-50 p-6">
            <div class="bg-white rounded-[3rem] p-10 w-full max-w-xs text-center space-y-6 shadow-2xl">
                <div id="result-emoji" class="text-8xl"></div>
                <h2 id="result-title" class="text-2xl font-black"></h2>
                <div class="p-5 bg-slate-50 rounded-2xl">
                    <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">Ê≠£Ëß£</p>
                    <span id="correct-name" class="text-2xl font-black text-slate-800"></span>
                </div>
                <button id="modal-next-btn" onclick="closeModal()" class="w-full premium-grad text-white py-5 rounded-2xl font-black shadow-lg transition active:scale-95">Ê¨°„Å∏ÈÄ≤„ÇÄ</button>
            </div>
        </div>

        <!-- Final Score Screen -->
        <div id="final-screen" class="hidden p-10 text-center space-y-10">
            <div class="space-y-2">
                <div class="text-7xl mb-4">üëë</div>
                <h2 class="text-4xl font-black">ÁµÇ‰∫ÜÔºÅ</h2>
            </div>
            <div class="py-10 bg-slate-50 rounded-[3rem]">
                <p class="text-7xl font-black text-orange-600" id="final-score-display">0</p>
                <p class="text-xs font-bold text-orange-400 mt-2 uppercase">Total Points</p>
            </div>
            <button onclick="location.reload()" class="w-full bg-slate-800 text-white py-6 rounded-2xl font-black shadow-2xl transition active:scale-95">„Çø„Ç§„Éà„É´„Å´Êàª„Çã</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden fixed inset-0 bg-white/95 z-50 flex flex-col items-center justify-center">
        <div class="loading-spinner"></div>
        <p class="mt-6 font-black text-orange-600 text-xs">AI„ÅåÂïèÈ°å„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...</p>
    </div>

    <script>
        let targetName = "";
        let currentTotalScore = 0;
        let currentQuestionIdx = 1;
        let currentHintLevel = 0;
        let hints = [];
        const MAX_QUESTIONS = 10;
        let currentAge = 20;

        // „Äê‰øÆÊ≠£„Éù„Ç§„É≥„Éà„ÄëAPI„Ç≠„Éº„Çí„Éñ„É©„Ç¶„Ç∂ÂÅ¥„ÅßÊåÅ„Åü„Åö„ÄÅVercel„ÅÆ„Çµ„Éº„Éê„Éº„É¨„ÇπÈñ¢Êï∞„Å´‰ªª„Åõ„Çã
        async function fetchAI(body) {
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    // Ëá™Ââç„ÅÆAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÔºà/api/quizÔºâ„ÇíÂè©„Åè
                    const res = await fetch('/api/quiz', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    
                    if (res.ok) return await res.json();
                    const errorData = await res.json();
                    throw new Error(errorData.error || "ÈÄö‰ø°„Ç®„É©„Éº");
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async function startGame(age) {
            currentAge = age;
            currentTotalScore = 0;
            currentQuestionIdx = 1;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            nextQuestion();
        }

        async function nextQuestion() {
            if (currentQuestionIdx > MAX_QUESTIONS) {
                showFinalResult();
                return;
            }

            document.getElementById('loading-screen').classList.remove('hidden');
            currentHintLevel = 0;
            document.getElementById('answer-input').value = "";
            document.getElementById('current-idx-display').innerText = currentQuestionIdx;
            
            for(let i=1; i<=3; i++) document.getElementById(`hint-${i}`).classList.add('hidden');

            try {
                const response = await fetchAI({
                    contents: [{ parts: [{ text: `${currentAge}‰ª£„Å´ÈùûÂ∏∏„Å´ÊúâÂêç„Å™Êó•Êú¨„ÅÆÊúâÂêç‰∫∫„Çí1‰∫∫ÈÅ∏„Å≥„ÄÅ„ÇØ„Ç§„Ç∫„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇJSON„ÅÆ„ÅøÔºö{"name":"ÂêçÂâç","hint1":"Á¨¨1„Éí„É≥„Éà(ËÅ∑Ê•≠)","hint2":"Á¨¨2„Éí„É≥„Éà(‰ª£Ë°®‰Ωú)","hint3":"Á¨¨3„Éí„É≥„Éà(ÂêçÂ≠ó„ÅÆ‰∏ÄÊñáÂ≠ó)"}` }] }],
                    generationConfig: { responseMimeType: "application/json" }
                });
                
                const data = JSON.parse(response.candidates[0].content.parts[0].text);
                targetName = data.name;
                hints = [data.hint1, data.hint2, data.hint3];
                document.getElementById('loading-screen').classList.add('hidden');
                revealNextHint();
            } catch (e) {
                document.getElementById('loading-screen').classList.add('hidden');
                alert(`„Ç®„É©„Éº: ${e.message}`);
                location.reload();
            }
        }

        function revealNextHint() {
            if (currentHintLevel >= 3) return;
            currentHintLevel++;
            const h = document.getElementById(`hint-${currentHintLevel}`);
            document.getElementById(`hint-${currentHintLevel}-text`).innerText = hints[currentHintLevel-1];
            h.classList.remove('hidden');
            setTimeout(() => h.classList.add('show'), 50);
        }

        function checkAnswer() {
            const input = document.getElementById('answer-input').value.trim();
            if (!input) return;

            const normalize = (s) => s.replace(/\s+/g, '').replace(/[„ÅÅ-„Çì]/g, m => String.fromCharCode(m.charCodeAt(0) + 0x60));
            const isCorrect = normalize(input) === normalize(targetName);
            
            if (isCorrect) {
                let pts = currentHintLevel === 1 ? 100 : (currentHintLevel === 2 ? 50 : 30);
                currentTotalScore += pts;
                document.getElementById('total-score').innerText = currentTotalScore;
                document.getElementById('result-emoji').innerText = "üéâ";
                document.getElementById('result-title').innerText = "Ê≠£Ëß£„Åß„ÅôÔºÅ";
            } else {
                document.getElementById('result-emoji').innerText = "‚ùå";
                document.getElementById('result-title').innerText = "ÊÆãÂøµ...";
            }
            document.getElementById('correct-name').innerText = targetName;
            document.getElementById('result-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
            currentQuestionIdx++;
            nextQuestion();
        }

        function showFinalResult() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
            document.getElementById('final-score-display').innerText = currentTotalScore;
            
            const oldHigh = localStorage.getItem('quiz_high_score_pro') || 0;
            if (currentTotalScore > oldHigh) {
                localStorage.setItem('quiz_high_score_pro', currentTotalScore);
            }
        }

        document.getElementById('high-score-display').innerText = localStorage.getItem('quiz_high_score_pro') || 0;
    </script>
</body>
</html>